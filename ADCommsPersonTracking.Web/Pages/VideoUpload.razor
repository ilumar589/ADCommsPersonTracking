@page "/video-upload"
@inject IPersonTrackingApiService ApiService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Video Upload - ADComms Person Tracking</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Video Upload</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-3">Upload Video File</MudText>
                
                <MudFileUpload T="IBrowserFile" Accept="video/*" FilesChanged="HandleFileSelected" MaximumFileCount="1">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                   FullWidth="true"
                                   Disabled="@_uploading">
                            Select Video File
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>

                @if (!string.IsNullOrEmpty(_fileName))
                {
                    <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.Check" Class="mt-2">@_fileName</MudChip>
                }

                @* Frame count slider: allows users to select max frames to extract (10-300 range chosen for performance vs. quality balance) *@
                <MudText Typo="Typo.h6" Class="mt-4 mb-2">Frame Count</MudText>
                <MudSlider T="int" 
                           @bind-Value="_maxFrames" 
                           Min="10" 
                           Max="300" 
                           Step="10"
                           Color="Color.Primary"
                           Disabled="@_uploading">
                    Max Frames: @_maxFrames
                </MudSlider>
                <MudText Typo="Typo.caption" Class="mt-1 mb-2">
                    Select the maximum number of frames to extract from the video (10-300)
                </MudText>

                @if (_uploading)
                {
                    <MudProgressLinear Color="Color.Primary" Value="@_progressPercentage" Class="mt-4" />
                    <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-2">
                        @_currentStep (@_progressPercentage%)
                    </MudText>
                }

                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Upload"
                           OnClick="UploadVideo"
                           Disabled="@(_uploading || _selectedFile == null)"
                           FullWidth="true"
                           Class="mt-4">
                    @if (_uploading)
                    {
                        <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                        <span>Uploading...</span>
                    }
                    else
                    {
                        <span>Upload and Process Video</span>
                    }
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        @if (_uploadResponse != null)
        {
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-3">Upload Results</MudText>
                    
                    @if (_uploadResponse.WasCached)
                    {
                        <MudAlert Severity="Severity.Info" Class="mb-3">
                            <MudText>@_uploadResponse.Message</MudText>
                        </MudAlert>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Success" Class="mb-3">
                            <MudText>@_uploadResponse.Message</MudText>
                        </MudAlert>
                    }

                    <MudText Typo="Typo.body1" Class="mb-2">
                        <strong>Tracking ID:</strong> @_uploadResponse.TrackingId
                    </MudText>

                    @if (_uploadResponse.FrameCount > 0)
                    {
                        <MudText Typo="Typo.body1" Class="mb-3">
                            <strong>Frames Extracted:</strong> @_uploadResponse.FrameCount
                        </MudText>
                    }

                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Secondary" 
                               StartIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="ProceedToTracking"
                               FullWidth="true">
                        Proceed to Tracking
                    </MudButton>
                </MudCardContent>
            </MudCard>
        }
    </MudItem>
</MudGrid>

@code {
    private IBrowserFile? _selectedFile;
    private string _fileName = string.Empty;
    private bool _uploading = false;
    private VideoUploadResponse? _uploadResponse;
    private string? _currentJobId;
    private int _progressPercentage = 0;
    private string _currentStep = string.Empty;
    private CancellationTokenSource? _pollingCancellation;
    private int _maxFrames = 100;

    public void Dispose()
    {
        _pollingCancellation?.Cancel();
        _pollingCancellation?.Dispose();
    }

    private void HandleFileSelected(IBrowserFile file)
    {
        _selectedFile = file;
        _fileName = file?.Name ?? string.Empty;
        _uploadResponse = null;
        _currentJobId = null;
        _progressPercentage = 0;
        _currentStep = string.Empty;
        
        if (file != null)
        {
            Snackbar.Add($"Video file '{_fileName}' selected", Severity.Success);
        }
    }

    private async Task UploadVideo()
    {
        if (_selectedFile == null)
        {
            Snackbar.Add("Please select a video file", Severity.Warning);
            return;
        }

        _uploading = true;
        _uploadResponse = null;
        _progressPercentage = 0;
        _currentStep = "Starting upload...";

        // Cancel any existing polling
        _pollingCancellation?.Cancel();
        _pollingCancellation?.Dispose();
        _pollingCancellation = new CancellationTokenSource();

        try
        {
            const long maxFileSize = 500 * 1024 * 1024; // 500MB max
            
            using var stream = _selectedFile.OpenReadStream(maxFileSize);
            var jobResponse = await ApiService.UploadVideoAsync(stream, _selectedFile.Name, _maxFrames);

            if (jobResponse != null)
            {
                _currentJobId = jobResponse.JobId;
                Snackbar.Add("Video upload started. Processing...", Severity.Info);
                
                // Start polling for status
                await PollUploadStatus(_pollingCancellation.Token);
            }
            else
            {
                Snackbar.Add("Failed to upload video", Severity.Error);
                _uploading = false;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error uploading video: {ex.Message}", Severity.Error);
            _uploading = false;
        }
    }

    private async Task PollUploadStatus(CancellationToken cancellationToken)
    {
        while (!cancellationToken.IsCancellationRequested && _currentJobId != null)
        {
            try
            {
                await Task.Delay(1500, cancellationToken); // Poll every 1.5 seconds
                
                var status = await ApiService.GetVideoUploadStatusAsync(_currentJobId);
                
                if (status == null)
                {
                    Snackbar.Add("Failed to get upload status", Severity.Error);
                    _uploading = false;
                    break;
                }

                _progressPercentage = status.ProgressPercentage;
                _currentStep = status.CurrentStep;
                StateHasChanged();

                if (status.Status == "Completed")
                {
                    // Create a response object for the UI
                    _uploadResponse = new VideoUploadResponse
                    {
                        TrackingId = status.TrackingId ?? string.Empty,
                        FrameCount = status.FrameCount ?? 0,
                        WasCached = false,
                        Message = $"Video processed successfully! Extracted {status.FrameCount ?? 0} frames."
                    };
                    
                    Snackbar.Add($"Video processed successfully! Extracted {status.FrameCount ?? 0} frames.", Severity.Success);
                    _uploading = false;
                    break;
                }
                else if (status.Status == "Failed")
                {
                    Snackbar.Add($"Video processing failed: {status.ErrorMessage}", Severity.Error);
                    _uploading = false;
                    break;
                }
            }
            catch (OperationCanceledException)
            {
                // Polling was cancelled, exit gracefully
                break;
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error checking upload status: {ex.Message}", Severity.Error);
                _uploading = false;
                break;
            }
        }
    }

    private void ProceedToTracking()
    {
        if (_uploadResponse != null)
        {
            NavigationManager.NavigateTo($"/track-submission?trackingId={_uploadResponse.TrackingId}");
        }
    }
}
