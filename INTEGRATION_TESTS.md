# YOLO11 Integration Tests

This document describes the YOLO11 ONNX model integration tests with real model inference.

## Overview

The integration tests in `ADCommsPersonTracking.Tests/Integration/YoloIntegrationTests.cs` validate the YOLO11 person detection functionality by:

1. Loading the actual YOLO11 ONNX model in the C# ObjectDetectionService
2. Running real inference on test images
3. Validating detection results and bounding box outputs

These tests use the actual production code (`ObjectDetectionService`) with the real YOLO11 model to ensure accurate integration validation.

## Prerequisites

### Required Software
- .NET 10 SDK
- YOLO11 ONNX model (yolo11m.onnx)

### Download the YOLO11 Model

Before running the integration tests, you need to download the YOLO11 ONNX model:

#### Option 1: Using Python Script (Recommended)
```bash
# Install ultralytics
pip install ultralytics

# Run the download script
python download-model.py
```

#### Option 2: Manual Download with Ultralytics
```bash
pip install ultralytics
python -c "from ultralytics import YOLO; model = YOLO('yolo11m.pt'); model.export(format='onnx', simplify=True, dynamic=False, imgsz=640)"
mv yolo11m.onnx models/
```

The model will be saved to `models/yolo11m.onnx` (~50MB).

## Running the Integration Tests

**Important**: Ensure the YOLO11 model is downloaded before running integration tests.

### All Integration Tests
```bash
# Run only integration tests by category
dotnet test --filter "Category=Integration"

# Run with detailed output
dotnet test --filter "Category=Integration" --logger "console;verbosity=detailed"

# Alternative: Run by namespace
dotnet test --filter "FullyQualifiedName~Integration"
```

### Specific Test
```bash
dotnet test --filter "FullyQualifiedName~YoloIntegrationTests.DetectPersonsAsync_ModelLoadsSuccessfully"
```

### Unit Tests Only (Excluding Integration)
```bash
# Skip integration tests (useful for CI where model might not be downloaded)
dotnet test --filter "Category!=Integration"

# Or exclude by namespace
dotnet test --filter "FullyQualifiedName!~Integration"
```

### All Tests (Unit + Integration)
```bash
dotnet test
```

## Test Scenarios

The integration test suite covers the following scenarios:

### 1. Model Loading
- **Test**: `DetectPersonsAsync_ModelLoadsSuccessfully`
- **Purpose**: Verifies the YOLO11 ONNX model loads correctly in the ObjectDetectionService
- **Expected**: Service initializes successfully and can process images

### 2. No Person Detection - Solid Color
- **Test**: `DetectPersonsAsync_WithImageWithoutPerson_ReturnsNoDetections`
- **Purpose**: Validates that solid color images don't trigger false person detections
- **Expected**: Zero detections

### 3. Empty Scene Detection
- **Test**: `DetectPersonsAsync_WithEmptyScene_ReturnsNoDetections`
- **Purpose**: Validates that gradient/empty scenes don't trigger false detections
- **Expected**: Zero detections

### 4. Bounding Box Format
- **Test**: `DetectPersonsAsync_BoundingBoxFormat_IsCorrect`
- **Purpose**: Validates the structure and format of detection results
- **Expected**: All required fields present with valid values (x, y, width, height, confidence, label)

### 5. Confidence Threshold Validation
- **Test**: `DetectPersonsAsync_DetectionsHaveValidConfidence`
- **Purpose**: Ensures all detections meet the minimum confidence threshold
- **Expected**: All detections have confidence >= 0.45 and <= 1.0

### 6. Consistency Check
- **Test**: `DetectPersonsAsync_WithMultipleImages_ProducesConsistentResults`
- **Purpose**: Validates that running inference multiple times produces consistent results
- **Expected**: Same image produces same detection count

### 7. Performance Test
- **Test**: `DetectPersonsAsync_WithValidImage_CompletesWithinReasonableTime`
- **Purpose**: Ensures inference completes in reasonable time
- **Expected**: Detection completes within 10 seconds

## Test Images

Test images are located in `ADCommsPersonTracking.Tests/TestData/Images/`:

- `person.jpg` - Simple person-like shape (blue shirt, skin-tone head, black legs)
- `no_person.jpg` - Solid blue background
- `empty_scene.jpg` - Gradient background

These images are generated by the `create-test-images.py` script.

## Integration Test Architecture

The integration tests directly use the C# `ObjectDetectionService` with the actual YOLO11 ONNX model:

- **Service**: `ADCommsPersonTracking.Api.Services.ObjectDetectionService`
- **Model**: YOLO11n ONNX (~11MB)
- **Runtime**: Microsoft.ML.OnnxRuntime 1.20.1
- **Test Framework**: xUnit with FluentAssertions

### Key Files
- `ADCommsPersonTracking.Tests/Integration/YoloIntegrationTests.cs` - Integration test suite
- `models/yolo11m.onnx` - YOLO11 model (downloaded via script, not committed)
- `ADCommsPersonTracking.Tests/TestData/Images/` - Test images

## CI/CD Considerations

### GitHub Actions

The integration tests can run in GitHub Actions:

```yaml
jobs:
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Download YOLO11 model
        run: |
          pip install ultralytics
          python download-model.py
      
      - name: Run integration tests
        run: dotnet test --filter "Category=Integration"
```

## Troubleshooting

### Model Not Found
```
InvalidOperationException: YOLO11 model not found at models/yolo11m.onnx
```
**Solution**: Run `python download-model.py` to download the model before running integration tests.

### ONNX Runtime Errors
```
Error: Failed to load ONNX model
```
**Solution**: 
- Ensure the model file is not corrupted (should be ~11MB)
- Re-download the model using `python download-model.py`
- Verify Microsoft.ML.OnnxRuntime package is installed

### Test Images Not Found
```
FileNotFoundException: Could not find file 'TestData/Images/person.jpg'
```
**Solution**: 
- Ensure test images exist in `ADCommsPersonTracking.Tests/TestData/Images/`
- Run `python create-test-images.py` to generate test images if missing

### Tests Run Slowly
**Solution**: 
- Integration tests perform real ONNX inference which can take 1-10 seconds per test on CPU
- This is expected behavior for integration tests with real model inference
- Consider using `--filter "Category!=Integration"` to skip these tests during rapid development

## Performance Notes

- **Model Loading**: ~1-3 seconds when ObjectDetectionService initializes
- **Inference**: ~100-500ms per image on CPU (640x640 input)
- **Test Suite**: ~10-30 seconds for all 7 integration tests
- **First Run**: Same as subsequent runs (no Docker caching needed)

## Local Development

For faster iteration during development, you can skip integration tests:

```bash
# Run only unit tests (skips integration tests)
dotnet test --filter "Category!=Integration"

# Run with watch mode for rapid feedback
dotnet watch test --filter "Category!=Integration"
```

To run integration tests after making changes:

```bash
# Ensure model is downloaded
python download-model.py

# Run integration tests only
dotnet test --filter "Category=Integration"
```

## Additional Resources

- [YOLO11 Documentation](https://docs.ultralytics.com/)
- [ONNX Runtime Documentation](https://onnxruntime.ai/)
- [Microsoft.ML.OnnxRuntime NuGet Package](https://www.nuget.org/packages/Microsoft.ML.OnnxRuntime/)
- [xUnit Testing Framework](https://xunit.net/)
